VIEW_PENDENTES_CORTE_COR

CREATE OR ALTER VIEW PDS_PENDENTES_CORTE_COR(
    REQUISICAO,
    CORTE,
    "NR. ORDEM CORTE",
    "MÁQUINA",
    CELULA,
    "DATA GERAÇÃO",
    "DATA ENTREGA",
    "OBSERVAÇÃO REQ",
    CHICOTE,
    PD,
    CPD,
    CABO,
    COR,
    VIAS,
    BITOLA,
    UNIDADE,
    NORMA,
    "QTD PD RQ",
    QTD_CORTADA,
    MEDIDA,
    "DECAPE A",
    "DECAPE B",
    "ACABAMENTO 1",
    "PONTE 1",
    "ACABAMENTO 2",
    "PONTE 2",
    "ACABAMENTO 3",
    "PONTE 3",
    "ACABAMENTO 4",
    "PONTE 4",
    "OBSERVAÇÃO",
    "GRAVAÇÃO")
AS
SELECT
    REQ.PK_REQ "REQUISICAO",
    COR.PK_COR "CORTE",
    LCO.PK_LCO "NR. ORDEM CORTE",
    MAQ.DESCRICAO "MÁQUINA",
    CEL.DESCRICAO "CELULA",
    REQ.DATA "DATA GERAÇÃO",
    REQ.ENTREGA "DATA ENTREGA",
    REQ.OBSERVACAO "OBSERVAÇÃO REQ",
    PAI.COD_FABRIC "CHICOTE",
    PCT.PK_PCT "PD",
    CABO.PK_PRO "CPD",
    CABO.COD_FABRIC "CABO",
    CABO.FK_CRS "COR",
    BIT.QTD_VIAS "VIAS",
    BIT.BITOLA "BITOLA",
    CASE
        BIT.UNIDADE
        WHEN 'A' THEN 'AWG'
        ELSE 'MM2'
    END "UNIDADE",
    NOR.DESCRICAO "NORMA",
    SUM(IQC.QUANTIDADE)*1000 / PCT.MEDIDA "QTD PD RQ",
    SUM(IQC.QTD_CORTADA)*1000 / PCT.MEDIDA "QTD_CORTADA",
    PCT.MEDIDA "MEDIDA",
    PCT.DECAPE1 "DECAPE A",
    PCT.DECAPE2 "DECAPE B",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB1) "ACABAMENTO 1",
    COR.PONTE1 "PONTE 1",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB2) "ACABAMENTO 2",
    COR.PONTE2 "PONTE 2",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB3) "ACABAMENTO 3",
    COR.PONTE3 "PONTE 3",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB4) "ACABAMENTO 4",
    COR.PONTE4 "PONTE 4",
    COR.OBSERVACAO "OBSERVAÇÃO",
    PCT.GRAVACAO "GRAVAÇÃO"

FROM
    REQUISICOES REQ
    JOIN CELULA_PRODUCAO CEL ON CEL.PK_CEL = REQ.FK_CEL
    JOIN ITE_REQ IRQ ON IRQ.FK_REQ = REQ.PK_REQ
    JOIN PRODUTOS PAI ON PAI.PK_PRO = IRQ.FK_PRO
    JOIN CORTES COR ON COR.FK_PRO = PAI.PK_PRO
    JOIN PROCORTES PCT ON PCT.PK_PCT = COR.FK_PCT
    JOIN PRODUTOS CABO ON CABO.PK_PRO = COR.FK_PROCORTAR
    JOIN BITOLAS BIT ON BIT.PK_BIT = CABO.FK_BIT
    JOIN NORMAS_TEC NOR ON NOR.PK_NOR = CABO.FK_NOR

    JOIN IRQ_COR IQC ON IQC.FK_COR = COR.PK_COR AND IQC.FK_IRQ = IRQ.PK_IRQ

    JOIN IRQ_PD IRP ON IRP.FK_COR = COR.PK_COR AND IRP.FK_IRQ = IRQ.PK_IRQ
    JOIN LISTA_CORTE LCO ON LCO.PK_LCO = IRP.FK_LCO
    JOIN MAQUINAS MAQ ON MAQ.PK_MAQ = LCO.FK_MAQ

WHERE
    REQ.TIPO = 'C' AND
    REQ.DATA > '01.01.2020' AND
    IQC.QUANTIDADE > IQC.QTD_CORTADA

GROUP BY
    "REQUISICAO",
    "CORTE",
    "CELULA",
    "DATA GERAÇÃO",
    "DATA ENTREGA",
    "OBSERVAÇÃO REQ",
    "CHICOTE",
    "PD",
    "CPD",
    "CABO",
    "COR",
    "VIAS",
    "BITOLA",
    "UNIDADE",
    "NORMA",
    "MEDIDA",
    "DECAPE A",
    "DECAPE B",
    "PONTE 1",
    "PONTE 2",
    "PONTE 3",
    "PONTE 4",
    PCT.FK_PROACAB1,
    PCT.FK_PROACAB2,
    PCT.FK_PROACAB3,
    PCT.FK_PROACAB4,
    "OBSERVAÇÃO",
    "GRAVAÇÃO",
    "NR. ORDEM CORTE",
    "MÁQUINA"

HAVING
    SUM(IQC.QTD_ATENDIDA) < SUM(IQC.QUANTIDADE)

ORDER BY
    CABO.COD_FABRIC,
    PCT.MEDIDA DESC
;