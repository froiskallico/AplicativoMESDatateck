SP_ATENDE_CORTES


SET TERM ^ ;

create or alter procedure ATENDE_CORTES (
    QUANTIDADE_EM_METROS double precision,
    CORTE double precision,
    REQUISICAO double precision)
returns (
    QUANTIDADE double precision,
    QTD_CORTADA double precision,
    QTD_PENDENTE double precision,
    PK_IQC double precision)
as
declare variable QTD double precision;
BEGIN
    
  QTD = QUANTIDADE_EM_METROS;

  WHILE (QTD > 0) DO
   BEGIN
      FOR
        SELECT FIRST 1
            IQC.PK_IQC,
            IQC.QUANTIDADE,
            IQC.QTD_CORTADA,
            IQC.QUANTIDADE - IQC.QTD_CORTADA "QTD_PENDENTE"
        FROM
            IRQ_COR IQC
        WHERE
            IQC.QTD_CORTADA < IQC.QUANTIDADE AND
            IQC.FK_COR = :CORTE AND
            IQC.FK_IRQ IN  (SELECT
                                PK_IRQ
                            FROM
                                ITE_REQ IRQ
                            WHERE
                                IRQ.FK_REQ = :REQUISICAO)
        ORDER BY
            IQC.QUANTIDADE DESC
    
        INTO :PK_IQC, :QUANTIDADE, :QTD_CORTADA, :QTD_PENDENTE
      DO
      BEGIN
        IF (:QTD <= :QTD_PENDENTE) THEN
            begin
                UPDATE
                    IRQ_COR IQC
                SET   
                    IQC.QTD_CORTADA = IQC.QTD_CORTADA + :QTD
                WHERE
                    IQC.PK_IQC = :PK_IQC;
                QTD = 0;
            end 
        ELSE
            BEGIN
                UPDATE
                   IRQ_COR IQC
                SET
                    IQC.QTD_CORTADA = IQC.QTD_CORTADA + :QTD_PENDENTE
                WHERE IQC.PK_IQC = :PK_IQC;
                QTD = QTD - QTD_PENDENTE;
            END

        SUSPEND;

      END


  END
END^

SET TERM ; ^