CREATE OR ALTER VIEW PDS_PENDENTES_CORTE(
    PK_IRP,
    REQUISICAO,
    CELULA,
    "DATA GERA플O",
    "DATA ENTREGA",
    "OBSERVA플O REQ",
    CHICOTE,
    PD,
    CPD,
    CABO,
    COR,
    VIAS,
    BITOLA,
    UNIDADE,
    "QTD PD REQ",
    "QTD PD CORTADA",
    MEDIDA,
    "DECAPE A",
    "DECAPE B",
    "ACABAMENTO 1",
    "PONTE 1",
    "ACABAMENTO 2",
    "PONTE 2",
    "ACABAMENTO 3",
    "PONTE 3",
    "ACABAMENTO 4",
    "PONTE 4",
    "OBSERVA플O",
    "GRAVA플O",
    "M핽UINA",
    "NR. ORDEM CORTE")
AS
SELECT
    IRP.PK_IRP,
    REQ.PK_REQ "REQUISICAO",
    CEL.DESCRICAO "CELULA",
    REQ.DATA "DATA GERA플O",
    REQ.ENTREGA "DATA ENTREGA",
    REQ.OBSERVACAO "OBSERVA플O REQ",
    PAI.COD_FABRIC "CHICOTE",
    PCT.PK_PCT "PD",
    CABO.PK_PRO "CPD",
    CABO.COD_FABRIC "CABO",
    CABO.FK_CRS "COR",
    BIT.QTD_VIAS "VIAS",
    BIT.BITOLA "BITOLA",
    CASE
        BIT.UNIDADE
        WHEN 'A' THEN 'AWG'
        ELSE 'MM2'
    END "UNIDADE",
    IRP.QUANTIDADE "QTD PD REQ",
    IRP.QTD_CORTADA "QTD PD CORTADA",
    PCT.MEDIDA "MEDIDA",
    PCT.DECAPE1 "DECAPE A",
    PCT.DECAPE2 "DECAPE B",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB1) "ACABAMENTO 1",
    COR.PONTE1 "PONTE 1",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB2) "ACABAMENTO 2",
    COR.PONTE2 "PONTE 2",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB3) "ACABAMENTO 3",
    COR.PONTE3 "PONTE 3",
    (SELECT COD_FABRIC FROM PRODUTOS WHERE PK_PRO = PCT.FK_PROACAB4) "ACABAMENTO 4",
    COR.PONTE4 "PONTE 4",
    COR.OBSERVACAO "OBSERVA플O",
    PCT.GRAVACAO "GRAVA플O",
    MAQ.DESCRICAO "M핽UINA",
    LCO.PK_LCO "NR. ORDEM CORTE"

FROM
    REQUISICOES REQ
    JOIN CELULA_PRODUCAO CEL ON CEL.PK_CEL = REQ.FK_CEL
    JOIN ITE_REQ IRQ ON IRQ.FK_REQ = REQ.PK_REQ
    JOIN PRODUTOS PAI ON PAI.PK_PRO = IRQ.FK_PRO
    JOIN CORTES COR ON COR.FK_PRO = PAI.PK_PRO
    JOIN PROCORTES PCT ON PCT.PK_PCT = COR.FK_PCT
    JOIN PRODUTOS CABO ON CABO.PK_PRO = COR.FK_PROCORTAR
    JOIN IRQ_PD IRP ON IRP.FK_IRQ = IRQ.PK_IRQ AND IRP.FK_COR = COR.PK_COR
    JOIN LISTA_CORTE LCO ON LCO.PK_LCO = IRP.FK_LCO
    JOIN MAQUINAS MAQ ON MAQ.PK_MAQ = LCO.FK_MAQ
    JOIN BITOLAS BIT ON BIT.PK_BIT = CABO.FK_BIT

WHERE
    REQ.TIPO = 'C' AND
    (IRQ.QUANTIDADE - COALESCE(IRQ.QTD_ATENDIDA, 0) - COALESCE(IRQ.QTD_CANCELADA, 0))> 0 AND
    IRP.QUANTIDADE > COALESCE(IRP.QTD_CORTADA, 0)

ORDER BY
    CABO.COD_FABRIC,
    PCT.MEDIDA DESC
;